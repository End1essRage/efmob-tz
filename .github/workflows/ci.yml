name: CI

on:
  push:
    branches: [master]
  pull_request:
  workflow_dispatch:
    inputs:
      run_integration_tests:
        description: "Run integration tests"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

env:
  GO_VERSION: "1.24"
  GOFLAGS: "-mod=readonly"
  SERVICES: "subs"
  COMPOSE_FILES: |
    docker-compose.yaml
    ./observability/docker-compose.yaml
    ./infrastructure/docker-compose.yaml

jobs:
  # --------------------
  # LINT
  # --------------------
  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - uses: golangci/golangci-lint-action@v7
        with:
          version: v2.8.0
          args: --config .golangci.ci.yml

  # --------------------
  # COVERAGE
  # --------------------
  coverage:
    runs-on: ubuntu-latest
    needs: [test, test-integration] # если integration запускались
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Merge coverage
        run: |
          go install github.com/wadey/gocovmerge@latest
          go mod tidy
          gocovmerge coverage_unit.out coverage_integration.out > coverage_total.out
          go tool cover -func=coverage_total.out

  # --------------------
  # UNIT TESTS
  # --------------------
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - run: go test -v ./...

  # --------------------
  # INTEGRATION TESTS
  # --------------------
  test-integration:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - run: go test -tags=integration -v ./...

  # --------------------
  # API TESTS (HURL)
  # --------------------
  api-tests:
    name: Hurl API Tests (ENV=dev)
    runs-on: ubuntu-latest
    continue-on-error: true

    env:
      ENV: dev
      PORT: 8080

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install hurl
        run: |
          curl -L https://github.com/Orange-OpenSource/hurl/releases/download/4.2.0/hurl_4.2.0_amd64.deb -o hurl.deb
          sudo dpkg -i hurl.deb

      - name: Build subs service
        run: go build -o subs ./cmd/subs

      - name: Start subs service (ENV=dev)
        run: |
          ./subs &
          echo $! > subs.pid

      - name: Wait for service
        run: |
          for i in {1..20}; do
            if curl -sf http://localhost:8080/health; then
              echo "Service is up"
              exit 0
            fi
            echo "Waiting..."
            sleep 2
          done
          echo "Service did not start"
          exit 1

      - name: Run HURL tests
        run: |
          for file in tests/**/*.hurl; do
            echo "Running $file"
            hurl --test "$file"
          done

      - name: Stop service
        if: always()
        run: |
          kill $(cat subs.pid) || true

  # --------------------
  # SEMGREP (PR)
  # --------------------
  semgrep:
    name: Semgrep SAST
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto

  # --------------------
  # GOVULNCHECK
  # --------------------
  govulncheck:
    name: Go vulnerability check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: govulncheck ./...

  # --------------------
  # SWAGGER CHECK
  # --------------------
  swagger-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate swagger
        run: |
          for service in $SERVICES; do
            swag init \
              -g main.go \
              -d cmd/$service,pkg/$service/interfaces/http \
              -o cmd/$service/docs \
              --outputTypes json,go
          done

      - name: Check diff
        run: git diff --exit-code

  # --------------------
  # BUILD SWAGGER SITE
  # --------------------
  swagger-pages:
    if: github.ref == 'refs/heads/master'
    needs: swagger-check
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    env:
      SERVICES: "subs"

    steps:
      - uses: actions/checkout@v4

      - name: Make scripts executable
        run: |
          chmod +x .github/scripts/*.sh

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Swagger UI
        run: |
          npm init -y
          npm install swagger-ui-dist

      - name: Build GitHub Pages
        run: ./.github/scripts/build-swagger-site.sh

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  # --------------------
  # DEPLOY PAGES
  # --------------------
  deploy-pages:
    needs: swagger-pages
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/deploy-pages@v4
        id: deployment
