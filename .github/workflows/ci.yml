name: CI

on:
  push:
    branches: [master]
  pull_request:

env:
  GO_VERSION: "1.24"
  GOFLAGS: "-mod=readonly"
  SERVICES: subs

jobs:
  # --------------------
  # LINT
  # --------------------
  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - uses: golangci/golangci-lint-action@v7
        with:
          version: v2.8.0
          args: --config .golangci.ci.yml

  # --------------------
  # UNIT TESTS
  # --------------------
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - run: go test -v -tags='!integration' ./...

  # --------------------
  # SWAGGER CHECK
  # --------------------
  swagger-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - run: go install github.com/swaggo/swag/cmd/swag@latest

      - name: Generate swagger
        run: |
          for service in $SERVICES; do
            swag init \
              -g main.go \
              -d cmd/$service,pkg/$service/interfaces/http \
              -o cmd/$service/docs \
              --outputTypes json,go
          done

      - name: Check diff
        run: git diff --exit-code

  # --------------------
  # BUILD SWAGGER SITE
  # --------------------
  swagger-pages:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Swagger UI
        run: |
          npm init -y
          npm install swagger-ui-dist

      - name: Build GitHub Pages
        run: |
          set -e

          # --------------------
          # Prepare folders
          # --------------------
          mkdir -p public/swagger-ui public/docs

          # --------------------
          # Copy Swagger UI
          # --------------------
          cp -r node_modules/swagger-ui-dist/* public/swagger-ui/

          # --------------------
          # Copy swagger specs
          # --------------------
          for service in $SERVICES; do
            if [ -f "cmd/$service/docs/swagger.json" ]; then
              cp cmd/$service/docs/swagger.json public/docs/$service-swagger.json
            else
              echo "âŒ Swagger not found for service: $service"
              exit 1
            fi
          done

          # --------------------
          # Override swagger initializer
          # --------------------
          cat > public/swagger-ui/swagger-initializer.js << 'EOF'
          window.onload = function () {
            const params = new URLSearchParams(window.location.search);
            const service = params.get("service") || "subs";

            const specUrl = "../docs/" + service + "-swagger.json";

            window.ui = SwaggerUIBundle({
              url: specUrl,
              dom_id: "#swagger-ui",
              deepLinking: true,
              presets: [
                SwaggerUIBundle.presets.apis,
                SwaggerUIStandalonePreset
              ],
              plugins: [
                SwaggerUIBundle.plugins.DownloadUrl
              ],
              layout: "StandaloneLayout"
            });
          };
          EOF

          # --------------------
          # Generate index.html
          # --------------------
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>API Documentation</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 40px; }
              ul { list-style: none; padding: 0; }
              li { margin: 10px 0; }
              a { color: #0969da; font-weight: bold; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>API Documentation</h1>
            <ul>
              <li>
                <a href="./swagger-ui/?service=subs">
                  Subs service
                </a>
              </li>
            </ul>
          </body>
          </html>
          EOF

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  # --------------------
  # DEPLOY PAGES
  # --------------------
  deploy:
    needs: swagger-pages
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/deploy-pages@v4
        id: deployment
