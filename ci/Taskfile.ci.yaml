version: "3"

env:
  SWAGGER_SERVICES: |
    subs

tasks:
  default:
    desc: "–õ–æ–∫–∞–ª—å–Ω—ã–π CI"
    cmds:
      - task: lint
      # - task: swagger
      # - task: docs
      # - task: test
      # - task: test-integration
      # - task: semgrep-full

  lint:
    cmds:
      - golangci-lint run --config .golangci.ci.yml

  test:
    cmds:
      - go test -v -tags='!integration' ./...

  test-integration:
    cmds:
      - go test -v -tags=integration ./...

  semgrep-full:
    cmds:
      - semgrep scan --config=auto --json  --output semgrep-full.json

  swagger:
    desc: "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è swagger"
    cmds:
      - echo "Start Swagger"
      - |
        {{- $services := splitList "\n" .SWAGGER_SERVICES -}}
        {{- range $service := $services -}}
          {{- $service = trim $service -}}
          {{- if ne $service "" -}}
        echo "–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é: {{$service}}"
        powershell -Command "if (Test-Path 'cmd/{{$service}}/main.go') {swag init -g 'main.go' -d 'cmd/{{$service}},pkg/{{$service}}/interfaces/http'  -o 'cmd/{{$service}}/docs' --outputTypes json,go; Write-Host '‚úÖ {{$service}} docs generated' } else { Write-Host '‚ö†Ô∏è  Service {{$service}} not found' }"
          {{- end -}}
        {{- end -}}

  docs:
    desc: "—Å–æ–±–∏—Ä–∞–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–≤–∞–≥–≥–µ—Ä –ø–æ –≤—Å–µ–º —Å–µ—Ä–≤–∏—Å–∞–º –≤ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É"
    cmds:
      - |
        {{- $services := splitList "\n" .SWAGGER_SERVICES -}}
        {{- range $service := $services -}}
          {{- $service = trim $service -}}
          {{- if ne $service "" -}}
        echo "üöÄ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é: {{$service}}"
        powershell -Command "
          if (Test-Path \"cmd/{{$service}}/main.go\") {

            # –°–æ–∑–¥–∞–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É docs –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (-not (Test-Path \"docs\")) {
              New-Item -ItemType Directory -Path \"docs\" | Out-Null
            }

            # –ö–æ–ø–∏—Ä—É–µ–º swagger.json –≤ –∫–æ—Ä–Ω–µ–≤—É—é –ø–∞–ø–∫—É docs —Å –∏–º–µ–Ω–µ–º —Å–µ—Ä–≤–∏—Å–∞
            if (Test-Path cmd/{{$service}}/docs/swagger.json) {
              Copy-Item -Path cmd/{{$service}}/docs/swagger.json -Destination docs/{{$service}}-swagger.json -Force
              Write-Host \"üìÑ {{$service}}-swagger.json copied to docs/\"
            }

          } else {
            Write-Host \"‚ö†Ô∏è  Service $service not found\"
          }
        "
          {{- end -}}
        {{- end -}}
