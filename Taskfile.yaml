version: "3"

includes:
  ci:
    taskfile: ./ci/Taskfile.ci.yaml
    optional: true

env:
  ## change
  COMPOSE_PROJECT_NAME: nosok
  COMPOSE_FILES: |
    docker-compose.yaml
    ./observability/docker-compose.yaml
    ./infrastructure/docker-compose.yaml

  ## change
  SERVICES: subs

vars:
  GOIMPORTS_VERSION: latest
  GOLANGCI_LINT_VERSION: v2.8.0
  SWAG_VERSION: latest

  COMPOSE_FILES_FLAGS: |
    {{- $flags := "" -}}
    {{- range (splitList "\n" .COMPOSE_FILES) -}}
      {{- if ne (trim .) "" -}}
        {{- $flags = printf "%s -f %s" $flags (trim .) -}}
      {{- end -}}
    {{- end -}}
    {{- trim $flags -}}

tasks:
  default:
    cmds:
      - task --list

  # --------------------
  # SETUP
  # --------------------
  setup:
    desc: "Bootstrap –ø—Ä–æ–µ–∫—Ç–∞: –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏, –ª–∏–Ω—Ç–µ—Ä—ã, —Ö—É–∫–∏"
    cmds:
      - task: check-go
      - task: install-tools
      - task: install-go-deps
      - task: setup-precommit
    silent: false

  check-go:
    desc: "–ü—Ä–æ–≤–µ—Ä–∫–∞ Go"
    cmds:
      - go version

  install-go-deps:
    desc: "–ó–∞–≥—Ä—É–∑–∫–∞ go.mod –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
    cmds:
      - go mod download

  install-tools:
    desc: "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ dev-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤"
    cmds:
      - echo "üîß Installing goimports"
      - go install golang.org/x/tools/cmd/goimports@{{.GOIMPORTS_VERSION}}

      - echo "üîß Installing golangci-lint"
      - go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@{{.GOLANGCI_LINT_VERSION}}

      - echo "üîß Installing swag"
      - go install github.com/swaggo/swag/cmd/swag@{{.SWAG_VERSION}}

      - echo "üîß Installing semgrep"
      - pip install semgrep

  setup-precommit:
    desc: "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ pre-commit –∏ git hooks"
    cmds:
      - |
        if ! command -v pre-commit >/dev/null 2>&1; then
          echo "‚ùå pre-commit not found"
          echo "üëâ Install it:"
          echo "   pip install pre-commit"
          exit 1
        fi
      - pre-commit install

  # --------------------
  # DEV ENV
  # --------------------
  up:
    desc: "–ó–∞–ø—É—Å–∫ dev –æ–∫—Ä—É–∂–µ–Ω–∏—è"
    cmds:
      - docker compose {{.COMPOSE_FILES_FLAGS}} up --build -d

  down:
    cmds:
      - docker compose {{.COMPOSE_FILES_FLAGS}} down

  logs:
    cmds:
      - docker compose {{.COMPOSE_FILES_FLAGS}} logs -f
    interactive: true

  # --------------------
  # TESTS
  # --------------------
  test:api:
    desc: "–ó–∞–ø—É—Å–∫ API —Ç–µ—Å—Ç–æ–≤ (Hurl)"
    cmds:
      - docker compose {{.COMPOSE_FILES_FLAGS}} run --rm api-tests

  e2e:
    desc: "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–µ–∑ –±–∏–ª–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –∞–ø–∏"
    cmds:
      - docker compose {{.COMPOSE_FILES_FLAGS}} restart {{.SERVICES}}
      - task test:api
